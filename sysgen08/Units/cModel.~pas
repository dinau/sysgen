unit cModel;

interface

uses
   Windows, Classes, SysUtils, FileCtrl, INIFiles,
   cModelItem;

type
   TOnModelSaved = procedure(pSender:TObject;pName:string) of object;
   TOnModelFound = procedure(pSender:TObject;pName:string) of object;
   TModels = class(TObject)
   private
      FModels:TList;
      FMicrochipPath:string;
      FMPASMPath:string;
      FMPLABPath:string;
      FOnModelSaved:TOnModelSaved;
      FOnModelFound:TOnModelFound;
      procedure SetPath(pPath:string);
      function GetFilenameNoExt(pFilename:string):string;
   public
      constructor Create;
      destructor Destroy;override;
      procedure Clear;
      procedure BuildCandidates;
      procedure GetCandidates(pLines:TStrings);
      procedure SaveModels(pPathBASIC,pPathInclude:string);
      property MicrochipPath:string read FMicrochipPath write SetPath;
      property MPASMPath:string read FMPASMPath;
      property MPLABPath:string read FMPLABPath;
      property OnModelSaved:TOnModelSaved read FOnModelSaved write FOnModelSaved;
      property OnModelFound:TOnModelFound read FOnModelFound write FOnModelFound;
   end;

implementation

{
****************************************************************************
* Name    :                                                                *
* Purpose :                                                                *
****************************************************************************
}
constructor TModels.Create;
begin
   inherited Create;
   FMicrochipPath := '';
   FMPASMPath := '';
   FMPLabPath := '';
   FModels := TList.Create;
end;
{
****************************************************************************
* Name    :                                                                *
* Purpose :                                                                *
****************************************************************************
}
destructor TModels.Destroy;
begin
   Clear;
   FModels.Free;
   inherited Destroy;
end;
{
****************************************************************************
* Name    :                                                                *
* Purpose :                                                                *
****************************************************************************
}
procedure TModels.Clear;
var
   Index:integer;
begin
   for index := 0 to FModels.Count - 1 do
      TModelItem(FModels.Items[index]).Free;
   FModels.Clear;
end;
{
****************************************************************************
* Name    :                                                                *
* Purpose :                                                                *
****************************************************************************
}
procedure TModels.SetPath(pPath:string);
begin
   FMicrochipPath := pPath;
   FMPASMPath := FMicrochipPath + '\MPASM Suite';
   FMPLABPath := FMicrochipPath + '\MPLAB IDE\Device';
end;
{
****************************************************************************
* Name    :                                                                *
* Purpose :                                                                *
****************************************************************************
}
function TModels.GetFilenameNoExt(pFilename:string):string;
var
   index :integer;
begin
   index := Length(pFilename);
   while (index > 0) and (pFilename[index] <> '.') do
      dec(index);
   result := Copy(pFilename,1,Length(pFilename) - (Length(pFilename) - index + 1));
end;
{
****************************************************************************
* Name    :                                                                *
* Purpose :                                                                *
****************************************************************************
}
procedure TModels.BuildCandidates;
var
   Found, Index:integer;
   SearchRec:TSearchRec;
   Device:string;
   Model:TModelItem;
   DeviceList:TStringList;
begin
   Clear;
   if DirectoryExists(FMPASMPath) and DirectoryExists(FMPLABPath) then
   begin
      DeviceList := TStringList.Create;
      Found := FindFirst(FMPASMPath + '\*.inc', faAnyFile, SearchRec);
      if Found = 0 then
      begin
         while Found = 0 do
            with SearchRec do
            begin
               Device := Uppercase(GetFilenameNoExt(SearchRec.Name));
               if Pos('P', Device) = 1 then
               begin
                  Device := Copy(Device,2,Length(Device));
                  if FileExists(FMPLABPath + '\PIC' + Device + '.dev') then
                     if Pos('18F',Device) > 0 then
                        DeviceList.Add(Device)
               end;
               Found := FindNext(SearchRec);
            end;
      end;
      FindClose(SearchRec);

      for Index := 0 to DeviceList.Count - 1 do
      begin
         Model := TModelItem.Create(FMPLABPath,FMPASMPath,DeviceList.Strings[Index]);
         if Model.IsValid then
         begin
            FModels.Add(Model);
            if Assigned(FOnModelFound) then
               FOnModelFound(self,Model.Device);
         end
         else
            Model.Free;
      end;
      DeviceList.Free;
   end;
end;
{
****************************************************************************
* Name    :                                                                *
* Purpose :                                                                *
****************************************************************************
}
procedure TModels.GetCandidates(pLines:TStrings);
var
   Index:integer;
begin
   for Index := 0 to FModels.Count - 1 do
      pLines.Add(TModelItem(FModels.Items[Index]).Device);
end;
{
****************************************************************************
* Name    :                                                                *
* Purpose :                                                                *
****************************************************************************
}
procedure TModels.SaveModels(pPathBASIC:string);
var
   Index:integer;
   Model:TModelItem;
   Lines:TStringList;
begin
   pPathBASIC := pPathBASIC + '\';
   if DirectoryExists(pPathBASIC) and DirectoryExists(pPathInclude) then
   begin
      Lines := TStringList.Create;
      for Index := 0 to FModels.Count - 1 do
      begin
         Model := TModelItem(FModels.Items[Index]);
         Lines.Clear;
         if Model.SaveToStrings(Lines) then
         begin
            Lines.SaveToFile(pPathBASIC + Model.Device + '.bas');
            if Assigned(FOnModelSaved) then
               FOnModelSaved(self,Model.Device);
         end;
      end;
      Lines.Free;
   end;
end;

end.
